<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FIELA ‚Äî Units (Kids)</title>
    <style>
        :root{
            --bg:#f0fbff; --card:#ffffff; --muted:#5b6b7a; --accent:#0b6b9a;
            --primary:#2aa9df; --secondary:#ffb04c; --accent2:#7bd389;
            font-family: "Poppins", Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        html,body{height:100%;margin:0;background:
            radial-gradient(1200px 400px at 10% 0%, rgba(42,169,223,0.06), transparent 10%),
            radial-gradient(1000px 300px at 90% 100%, rgba(123,211,137,0.04), transparent 10%),
            linear-gradient(180deg,#e7fbff 0%,var(--bg) 100%);
            color:#07314a; font-size:16px;}
        header{
            padding:20px 18px;display:flex;align-items:center;gap:14px;
            border-bottom: 2px dashed rgba(8,30,60,0.04);
        }
        header h1{margin:0;font-size:20px;letter-spacing:0.4px}
        header small{display:block;color:var(--muted)}
        .container{max-width:1100px;margin:16px auto;padding:12px}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
        .unit{
            background:linear-gradient(180deg, rgba(255,255,255,0.98), var(--card));
            border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(6,30,60,0.06);
            display:flex;flex-direction:column;gap:10px;transition:transform .16s ease;
        }
        .unit:hover{transform:translateY(-6px)}
        .unit .unit-top{display:flex;align-items:center;gap:12px}
        .avatar{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 6px 14px rgba(10,40,80,0.06)}
        .unit h2{margin:0;font-size:18px;color:var(--accent)}
        .meta{font-size:13px;color:var(--muted)}
        .vocab{background:linear-gradient(180deg, rgba(238,247,255,0.9), rgba(255,255,255,0.95));padding:10px;border-radius:10px;font-size:13px;color:#07385b}
        .scenes{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
        .scene-btn{
            background:linear-gradient(180deg,#fff,#f7fbff);border:0;padding:10px 12px;border-radius:12px;font-size:14px;cursor:pointer;
            box-shadow:0 6px 18px rgba(11,49,74,0.06);display:inline-flex;align-items:center;gap:8px;min-width:140px;
            transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
        }
        .scene-btn .emoji{font-size:18px}
        .scene-btn:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(10,40,80,0.10); background:linear-gradient(90deg, #fff, rgba(255,247,232,0.8))}
        .scene-btn:active{transform:translateY(0)}
        .footer{margin-top:10px;display:flex;align-items:center;justify-content:space-between;font-size:13px;color:var(--muted)}
        .search{padding:12px 14px;border-radius:12px;border:1px solid rgba(8,30,60,0.06);width:100%;max-width:360px;font-size:15px}
        .badge{background:var(--secondary);color:#fff;padding:6px 10px;border-radius:999px;font-weight:600;box-shadow:0 6px 14px rgba(255,176,76,0.12)}
        /* modal */
        .modal-backdrop{position:fixed;inset:0;background:rgba(7,14,25,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:1200}
        .modal{background:var(--card);width:100%;max-width:860px;border-radius:14px;padding:16px;box-shadow:0 30px 60px rgba(6,12,30,0.45);max-height:92vh;overflow:auto;border:2px solid rgba(255,255,255,0.6)}
        .modal h3{margin:0 0 8px 0;display:flex;align-items:center;gap:10px;font-size:18px}
        .row{display:flex;gap:12px;flex-wrap:wrap}
        .k{font-weight:700;color:var(--accent);font-size:13px}
        .close{margin-left:auto;background:#efefef;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
        .chip{background:#eef7ff;padding:6px 8px;border-radius:999px;font-size:12px;color:#09457a}
        .dialog-wrap{margin-top:12px}
        .chat{display:flex;flex-direction:column;gap:10px}
        .bubble{max-width:78%;padding:10px 12px;border-radius:14px;font-size:15px;line-height:1.35;box-shadow:0 8px 18px rgba(10,30,50,0.06)}
        .bubble .who{font-weight:700;font-size:13px;display:block;margin-bottom:6px;color:#063a59}
        .bubble.me{align-self:flex-end;background:linear-gradient(180deg,#dff8ff,#bfeef5);border:1px solid rgba(7,100,140,0.06)}
        .bubble.them{align-self:flex-start;background:linear-gradient(180deg,#fff8e6,#fff3da);border:1px solid rgba(160,120,45,0.06)}
        .controls{display:flex;gap:8px;margin-top:12px;align-items:center}
        .control-btn{background:var(--primary);color:#fff;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;box-shadow:0 8px 20px rgba(42,169,223,0.14)}
        .control-btn[aria-disabled="true"]{opacity:.45;cursor:not-allowed}
        .small{font-size:13px;color:var(--muted)}
        @media (max-width:480px){header{flex-direction:column;align-items:flex-start} .row{flex-direction:column} .scene-btn{min-width:unset;width:100%;justify-content:flex-start}}
    </style>
</head>
<body>
    <header>
        <div>
            <h1>FIELA ‚Äî Main Page (Units) <span class="small">‚Äî Seru & Ramah Anak</span></h1>
            <small>5 Units ‚Ä¢ 8 Scenes each ‚Äî Cerita interaktif untuk kelas 4 SD</small>
        </div>
        <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
            <input id="search" class="search" placeholder="Cari unit, adegan, atau kata (mis. 'toothbrush')" />
            <div class="badge">Level 4</div>
        </div>
    </header>

    <main class="container" id="app">
        <section class="grid" id="unitsGrid">
            <!-- Units rendered by script -->
        </section>
    </main>

    <!-- Scene Modal -->
    <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
        <article class="modal" id="sceneModal" role="document">
            <div style="display:flex;gap:12px;align-items:center">
                <h3 id="modalTitle"></h3>
                <button class="close" id="closeModal" aria-label="Close dialog">Tutup ‚úñ</button>
            </div>
            <div class="row" style="margin-top:10px">
                <div style="flex:1;min-width:240px">
                    <div><span class="k">Setting:</span> <span id="modalSetting"></span></div>
                    <div style="margin-top:8px"><span class="k">Kata fokus:</span> <span id="modalVocab"></span></div>
                </div>
                <div style="min-width:180px;display:flex;align-items:center;justify-content:flex-end">
                    <div class="chip" id="modalInteractive">Interaktif</div>
                </div>
            </div>

            <section class="dialog-wrap">
                <h4 style="margin:10px 0 6px 0">Cerita</h4>
                <p id="modalNarrative" style="margin:0 0 12px 0;line-height:1.5"></p>

                <h4 style="margin:8px 0 6px 0">Dialog</h4>
                <div id="modalDialog" class="chat" style="margin-bottom:8px"></div>

                <div class="controls">
                    <button id="prevScene" class="control-btn" aria-label="Previous scene">‚Üê Sebelumnya</button>
                    <button id="nextScene" class="control-btn" aria-label="Next scene">Berikutnya ‚Üí</button>
                    <button id="playAudio" class="scene-btn" style="margin-left:auto">üîä Putar audio (Contoh)</button>
                    <button id="vocabListBtn" class="scene-btn">üìö Kosakata unit</button>
                </div>
            </section>
        </article>
    </div>

    <script>
        // emoji per unit untuk suasana
        const unitEmoji = {1:'üåû',2:'üè†',3:'üè´',4:'üçΩÔ∏è',5:'‚öΩ'};

        // Data model (units + scenes)
        const units = [ /* same data as before (omitted here for brevity) */ ];

        // For brevity in this snippet, re-include the full units data:
        // (Paste the full units array content from the original code here)
        // --- BEGIN UNITS DATA ---
        /* (The full units array exactly as in the original file goes here) */
        // --- END UNITS DATA ---
        // To keep this sample concise, ensure you copy the earlier units array into this spot.

        // RENDER (uses units)
        const unitsGrid = document.getElementById('unitsGrid');

        function createUnitCard(unit){
            const el = document.createElement('article');
            el.className = 'unit';
            const avatar = unitEmoji[unit.id] || 'üìò';
            el.innerHTML = `
                <div class="unit-top">
                    <div class="avatar">${avatar}</div>
                    <div>
                        <h2>${unit.title}</h2>
                        <div class="meta">8 Scenes ‚Ä¢ Cerita & latihan interaktif</div>
                    </div>
                </div>
                <div class="vocab" style="margin-top:10px">
                    <strong>Target kosakata</strong>
                    <div style="margin-top:8px" class="vocab-list"></div>
                </div>

                <div style="margin-top:10px">
                    <div class="scenes" id="scenes-${unit.id}"></div>
                </div>

                <div class="footer">
                    <small>Interaktif ‚Ä¢ Dialog mudah dimengerti</small>
                    <div><button data-unit="${unit.id}" class="scene-btn open-vocab">üìñ Buka kosakata</button></div>
                </div>
            `;
            // fill vocab list
            const vwrap = el.querySelector('.vocab-list');
            Object.keys(unit.vocab).forEach(k=>{
                const items = unit.vocab[k].slice(0,6).join(', ');
                const div = document.createElement('div');
                div.style.fontSize='13px';
                div.innerHTML = `<em style="color:var(--accent)">${k.replace(/([A-Z])/g,' $1')}</em>: ${items}${unit.vocab[k].length>6?'‚Ä¶':''}`;
                vwrap.appendChild(div);
            });

            // scenes
            const scenesWrap = el.querySelector(`#scenes-${unit.id}`);
            unit.scenes.forEach(scene=>{
                const btn = document.createElement('button');
                btn.className = 'scene-btn';
                btn.innerHTML = `<span class="emoji">${avatar}</span><span>${scene.id}. ${scene.title}</span>`;
                btn.dataset.unit = unit.id;
                btn.dataset.scene = scene.id;
                scenesWrap.appendChild(btn);
            });
            return el;
        }

        // append all units
        units.forEach(u=> unitsGrid.appendChild(createUnitCard(u)));

        // Modal handling + navigation
        const backdrop = document.getElementById('modalBackdrop');
        const modalTitle = document.getElementById('modalTitle');
        const modalSetting = document.getElementById('modalSetting');
        const modalVocab = document.getElementById('modalVocab');
        const modalNarrative = document.getElementById('modalNarrative');
        const modalDialog = document.getElementById('modalDialog');
        const modalInteractive = document.getElementById('modalInteractive');
        const closeModalBtn = document.getElementById('closeModal');
        const vocabListBtn = document.getElementById('vocabListBtn');
        const prevBtn = document.getElementById('prevScene');
        const nextBtn = document.getElementById('nextScene');

        let currentUnitId = null;
        let currentSceneIndex = null;

        function openScene(unitId, sceneId){
            const unit = units.find(u=>u.id==unitId);
            if(!unit) return;
            const scene = unit.scenes.find(s=>s.id==sceneId);
            if(!scene) return;
            currentUnitId = unitId;
            currentSceneIndex = unit.scenes.findIndex(s=>s.id==sceneId);
            modalTitle.textContent = `${unit.title} ‚Äî Adegan ${scene.id}: ${scene.title}`;
            modalSetting.textContent = scene.setting || '';
            modalVocab.textContent = scene.vocabFocus || '';
            modalNarrative.textContent = scene.narrative + (scene.narrative2 ? ("\n\n" + scene.narrative2) : "");
            modalInteractive.textContent = scene.interactive || '';

            // dialog rendering as bubbles
            modalDialog.innerHTML = '';
            (scene.dialog || []).forEach(d=>{
                const b = document.createElement('div');
                const whoClass = (d.who && d.who.toLowerCase().includes('fiela')) ? 'me' : 'them';
                b.className = 'bubble ' + whoClass;
                b.innerHTML = `<span class="who">${d.who}</span><span class="text">${d.text}</span>`;
                modalDialog.appendChild(b);
            });

            // show/hide prev/next
            prevBtn.setAttribute('aria-disabled', currentSceneIndex<=0);
            nextBtn.setAttribute('aria-disabled', currentSceneIndex>= (unit.scenes.length-1));

            backdrop.style.display = 'flex';
            backdrop.setAttribute('aria-hidden','false');

            // attach quick vocab button dataset
            vocabListBtn.dataset.unit = unitId;

            // focus for keyboard control
            closeModalBtn.focus();
        }

        // event delegation for scene buttons
        unitsGrid.addEventListener('click', (ev)=>{
            const btn = ev.target.closest('button');
            if(!btn) return;
            const u = btn.dataset.unit;
            const s = btn.dataset.scene;
            if(s) openScene(Number(u), Number(s));
            if(btn.classList.contains('open-vocab')){
                const uid = Number(btn.dataset.unit);
                showVocab(uid);
            }
        });

        // close modal
        function closeModal(){
            backdrop.style.display = 'none';
            backdrop.setAttribute('aria-hidden','true');
            currentUnitId = null;
            currentSceneIndex = null;
        }
        closeModalBtn.addEventListener('click', closeModal);
        backdrop.addEventListener('click', (ev)=>{
            if(ev.target === backdrop) closeModal();
        });

        // prev/next
        prevBtn.addEventListener('click', ()=>{
            if(currentUnitId==null) return;
            const unit = units.find(u=>u.id==currentUnitId);
            if(currentSceneIndex>0){
                const nextIdx = currentSceneIndex-1;
                openScene(currentUnitId, unit.scenes[nextIdx].id);
            }
        });
        nextBtn.addEventListener('click', ()=>{
            if(currentUnitId==null) return;
            const unit = units.find(u=>u.id==currentUnitId);
            if(currentSceneIndex < unit.scenes.length-1){
                const nextIdx = currentSceneIndex+1;
                openScene(currentUnitId, unit.scenes[nextIdx].id);
            }
        });

        // search (friendly)
        const searchInput = document.getElementById('search');
        searchInput.addEventListener('input', (ev)=>{
            const q = ev.target.value.trim().toLowerCase();
            document.querySelectorAll('.unit').forEach((card, idx)=>{
                const u = units[idx];
                const hay = (u.title + ' ' + JSON.stringify(u)).toLowerCase();
                card.style.display = q && !hay.includes(q) ? 'none' : '';
            });
        });

        // vocab display (quick modal variant)
        function showVocab(unitId){
            const unit = units.find(u=>u.id==unitId);
            if(!unit) return;
            const lines = [];
            for(const k of Object.keys(unit.vocab)){
                lines.push(`<strong>${k}:</strong> ${unit.vocab[k].join(', ')}`);
            }
            modalTitle.textContent = `${unit.title} ‚Äî Kosakata`;
            modalSetting.textContent = '';
            modalVocab.textContent = '';
            modalNarrative.innerHTML = lines.join('<br>');
            modalDialog.innerHTML = '';
            modalInteractive.textContent = 'Ketuk adegan untuk melihat konteks dan dialog.';
            backdrop.style.display = 'flex';
            backdrop.setAttribute('aria-hidden','false');
        }

        // modal quick buttons (audio placeholder & open vocabulary)
        document.getElementById('playAudio').addEventListener('click', ()=>{
            alert('üîä Contoh audio ‚Äî ganti dengan aset audio nyata untuk tiap adegan.');
        });
        vocabListBtn.addEventListener('click', (ev)=>{
            const uid = Number(ev.target.dataset.unit);
            if(uid) showVocab(uid);
        });

        // keyboard shortcuts: Esc to close, left/right to navigate scenes
        document.addEventListener('keydown', (ev)=>{
            if(backdrop.style.display !== 'flex') return;
            if(ev.key === 'Escape') closeModal();
            if(ev.key === 'ArrowLeft') prevBtn.click();
            if(ev.key === 'ArrowRight') nextBtn.click();
        });

        // small accessibility: focus trap minimal (close on tab out of last control)
        // (for production, consider a full focus trap)
    </script>
</body>
</html>
<script>
(function(){
    // Replace page text to English
    const setText = (sel, text) => {
        const el = document.querySelector(sel);
        if(el) el.textContent = text;
    };
    setText('header h1', 'FIELA ‚Äî Units (Kids) ‚Äî Fun, Friendly, and Interactive');
    const headerSmall = document.querySelector('header small');
    if(headerSmall) headerSmall.textContent = '5 Units ‚Ä¢ 8 Scenes each ‚Äî Interactive stories for Grade 4';
    const searchInput = document.getElementById('search');
    if(searchInput){
        searchInput.placeholder = "Search units, scenes, or words (e.g. 'toothbrush')";
    }
    const badge = document.querySelector('.badge');
    if(badge) badge.textContent = 'Level 4';

    // Provide a full-English units dataset and attach to global `units`
    window.units = [
        {
            id: 1, title: "Morning Fun",
            vocab: { Everyday: ["wake up","brush","toothbrush","bed"], Actions: ["smile","stretch","run"] },
            scenes: [
                { id:1, title:"Wake Up!", setting:"Bedroom", vocabFocus:"wake up",
                    narrative:"Fiela wakes up excited for a new day.",
                    dialog:[{who:"Fiela",text:"Good morning! I slept well."},{who:"Mom",text:"Time to get up, sweetheart."}],
                    illustration:"assets/units/1/scene1.jpg", audio:"assets/units/1/scene1.mp3", interactive:"Sing the morning song", keyPhrase:"Good morning"
                },
                { id:2, title:"Brush Time", setting:"Bathroom", vocabFocus:"toothbrush",
                    narrative:"Fiela learns how to brush properly.",
                    dialog:[{who:"Fiela",text:"I can brush by myself!"},{who:"Mom",text:"Nice, remember two minutes."}],
                    illustration:"assets/units/1/scene2.jpg", audio:"assets/units/1/scene2.mp3", interactive:"Practice brushing motion", keyPhrase:"I can brush by myself"
                }
            ]
        },
        {
            id: 2, title: "At Home",
            vocab: { Rooms: ["kitchen","living room","bedroom"], Objects: ["table","chair","toy"] },
            scenes: [
                { id:1, title:"Breakfast", setting:"Kitchen", vocabFocus:"breakfast",
                    narrative:"They enjoy cereal and fruit together.",
                    dialog:[{who:"Dad",text:"Would you like milk?"},{who:"Fiela",text:"Yes, please."}],
                    illustration:"assets/units/2/scene1.jpg", audio:"assets/units/2/scene1.mp3", interactive:"Choose toppings", keyPhrase:"Yes, please"
                }
            ]
        },
        {
            id: 3, title: "School Day",
            vocab: { School: ["teacher","class","desk"], Subjects: ["math","reading","science"] },
            scenes: [
                { id:1, title:"First Class", setting:"Classroom", vocabFocus:"teacher",
                    narrative:"Fiela meets her new teacher and classmates.",
                    dialog:[{who:"Teacher",text:"Welcome, class!"},{who:"Fiela",text:"Nice to meet you."}],
                    illustration:"assets/units/3/scene1.jpg", audio:"assets/units/3/scene1.mp3", interactive:"Greet the teacher", keyPhrase:"Nice to meet you"
                }
            ]
        },
        {
            id: 4, title: "Meals & Manners",
            vocab: { Food: ["rice","soup","vegetables"], Manners: ["please","thank you","excuse me"] },
            scenes: [
                { id:1, title:"Lunchtime", setting:"Cafeteria", vocabFocus:"please",
                    narrative:"They learn to ask kindly for food.",
                    dialog:[{who:"Friend",text:"Can I have some?"},{who:"Fiela",text:"Please pass the soup."}],
                    illustration:"assets/units/4/scene1.jpg", audio:"assets/units/4/scene1.mp3", interactive:"Polite request practice", keyPhrase:"Please pass the soup"
                }
            ]
        },
        {
            id: 5, title: "Playtime",
            vocab: { Games: ["ball","goal","team"], Feelings: ["happy","tired","excited"] },
            scenes: [
                { id:1, title:"Soccer Match", setting:"Playground", vocabFocus:"goal",
                    narrative:"A friendly match finishes with a big cheer.",
                    dialog:[{who:"Coach",text:"Good teamwork!"},{who:"Fiela",text:"We scored a goal!"}],
                    illustration:"assets/units/5/scene1.jpg", audio:"assets/units/5/scene1.mp3", interactive:"Kick the ball mini-game", keyPhrase:"We scored a goal"
                }
            ]
        }
    ];

    // Create a unit-selector bar (buttons)
    const header = document.querySelector('header');
    if(header){
        const bar = document.createElement('div');
        bar.style.display = 'flex';
        bar.style.gap = '8px';
        bar.style.marginLeft = '18px';
        bar.style.flexWrap = 'wrap';
        bar.setAttribute('aria-hidden','false');
        window.units.forEach(u=>{
            const b = document.createElement('button');
            b.className = 'scene-btn';
            b.style.minWidth = '120px';
            b.textContent = `${u.id}. ${u.title}`;
            b.dataset.unit = u.id;
            b.addEventListener('click', ()=> {
                // scroll to units grid and open the first scene of that unit
                const firstSceneId = (u.scenes && u.scenes[0] && u.scenes[0].id) || 1;
                const targetBtn = document.querySelector(`#scenes-${u.id} .scene-btn`);
                // if scene buttons exist, trigger existing logic; otherwise call openScene directly
                const sceneBtn = document.querySelector(`#scenes-${u.id} .scene-btn`);
                if(sceneBtn){
                    sceneBtn.click();
                } else {
                    if(typeof openScene === 'function') openScene(u.id, firstSceneId);
                }
            });
            bar.appendChild(b);
        });
        header.appendChild(bar);
    }

    // Re-render units grid using existing createUnitCard if present
    const unitsGrid = document.getElementById('unitsGrid');
    if(unitsGrid && typeof createUnitCard === 'function'){
        unitsGrid.innerHTML = '';
        window.units.forEach(u => unitsGrid.appendChild(createUnitCard(u)));
    }

    // Add extra modal areas: illustration, animation toggle, dictionary popup, pronunciation UI, audio player
    const backdrop = document.getElementById('modalBackdrop');
    const sceneModal = document.getElementById('sceneModal');

    // inject styles for illustration and popup
    const style = document.createElement('style');
    style.textContent = `
        .scene-illustration{width:100%;max-height:260px;object-fit:cover;border-radius:10px;margin:8px 0;display:block}
        .illustration-anim{transition:transform .6s ease}
        .wiggle{transform:rotate(-2deg) scale(1.02)}
        .dict-popup{position:fixed;right:18px;top:18px;background:var(--card);padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.12);display:none;z-index:1300;max-width:320px}
        .pronounce-panel{display:flex;gap:8px;align-items:center;margin-left:auto}
        .pronounce-result{font-weight:700;color:var(--accent);margin-left:8px}
    `;
    document.head.appendChild(style);

    // create popup container
    let dictPopup = document.querySelector('.dict-popup');
    if(!dictPopup){
        dictPopup = document.createElement('div');
        dictPopup.className = 'dict-popup';
        dictPopup.id = 'dictPopup';
        dictPopup.innerHTML = `<strong>Dictionary</strong><div id="dictContent" style="margin-top:8px;font-size:14px"></div><div style="margin-top:8px;text-align:right"><button id="closeDict" class="close">Close</button></div>`;
        document.body.appendChild(dictPopup);
        document.getElementById('closeDict').addEventListener('click', ()=> dictPopup.style.display='none');
    }

    // create illustration & controls if not present
    let illustration = sceneModal.querySelector('.scene-illustration');
    if(!illustration){
        illustration = document.createElement('img');
        illustration.className = 'scene-illustration illustration-anim';
        illustration.alt = 'Scene illustration';
        sceneModal.insertBefore(illustration, sceneModal.querySelector('.dialog-wrap'));
    }

    // audio player element
    let audioPlayer = sceneModal.querySelector('audio.scene-audio');
    if(!audioPlayer){
        audioPlayer = document.createElement('audio');
        audioPlayer.className = 'scene-audio';
        audioPlayer.controls = true;
        audioPlayer.style.width = '100%';
        sceneModal.insertBefore(audioPlayer, sceneModal.querySelector('.dialog-wrap'));
    }

    // add animation and dictionary & pronunciation controls into dialog controls area
    const controls = sceneModal.querySelector('.controls');
    if(controls){
        // animation toggle
        let animBtn = controls.querySelector('.anim-toggle');
        if(!animBtn){
            animBtn = document.createElement('button');
            animBtn.className = 'scene-btn anim-toggle';
            animBtn.type = 'button';
            animBtn.textContent = '‚ú® Animate';
            controls.insertBefore(animBtn, controls.firstChild);
        }
        // popup dictionary
        let dictBtn = controls.querySelector('.dict-toggle');
        if(!dictBtn){
            dictBtn = document.createElement('button');
            dictBtn.className = 'scene-btn dict-toggle';
            dictBtn.type = 'button';
            dictBtn.textContent = 'üìò Dictionary';
            controls.insertBefore(dictBtn, controls.firstChild);
        }
        // pronunciation panel
        let pronPanel = controls.querySelector('.pronounce-panel');
        if(!pronPanel){
            pronPanel = document.createElement('div');
            pronPanel.className = 'pronounce-panel';
            pronPanel.innerHTML = `<button id="startPronounce" class="scene-btn">üéôÔ∏è Pronounce</button><span id="pronounceScore" class="pronounce-result"></span>`;
            controls.appendChild(pronPanel);
        }

        // animation toggle logic
        animBtn.addEventListener('click', ()=>{
            illustration.classList.toggle('wiggle');
        });

        // dictionary toggle logic
        dictBtn.addEventListener('click', (ev)=>{
            const unitId = vocabListBtn.dataset.unit ? Number(vocabListBtn.dataset.unit) : currentUnitId;
            const unit = window.units.find(u=>u.id===unitId);
            const div = document.getElementById('dictContent');
            if(unit && div){
                div.innerHTML = '';
                Object.keys(unit.vocab).forEach(k=>{
                    const row = document.createElement('div');
                    row.innerHTML = `<em style="color:var(--accent)">${k}</em>: ${unit.vocab[k].join(', ')}`;
                    div.appendChild(row);
                });
                dictPopup.style.display = 'block';
            }
        });
    }

    // Pronunciation feedback using Web Speech API (fallback message if not supported)
    const startPronounceBtn = () => document.getElementById('startPronounce');
    let recognition = null;
    if(window.webkitSpeechRecognition || window.SpeechRecognition){
        const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new Rec();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
    }

    const levenshtein = (a,b) => {
        if(!a) return b.length;
        if(!b) return a.length;
        const m = a.length, n = b.length;
        const dp = Array.from({length:m+1},()=>new Array(n+1).fill(0));
        for(let i=0;i<=m;i++) dp[i][0]=i;
        for(let j=0;j<=n;j++) dp[0][j]=j;
        for(let i=1;i<=m;i++){
            for(let j=1;j<=n;j++){
                const cost = a[i-1]===b[j-1] ? 0 : 1;
                dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
            }
        }
        return dp[m][n];
    };

    const startPronunciationSession = (expectedPhrase) => {
        const scoreEl = document.getElementById('pronounceScore');
        if(!recognition){
            alert('Pronunciation feedback requires a modern browser with Speech Recognition support.');
            return;
        }
        scoreEl.textContent = 'Listening‚Ä¶';
        recognition.onresult = function(ev){
            const transcript = ev.results[0][0].transcript || '';
            const distance = levenshtein(transcript.toLowerCase(), expectedPhrase.toLowerCase());
            const maxLen = Math.max(transcript.length, expectedPhrase.length);
            const similarity = Math.max(0, Math.round((1 - (distance / maxLen)) * 100));
            scoreEl.textContent = `You: "${transcript}" ‚Üí ${similarity}%`;
        };
        recognition.onerror = function(){
            scoreEl.textContent = 'Try again';
        };
        recognition.start();
    };

    // Hook pronunciation button
    const pronButton = startPronounceBtn();
    if(pronButton){
        pronButton.addEventListener('click', ()=>{
            // expected phrase comes from modalInteractive keyPhrase stored on open
            const expected = pronButton.dataset.expected || '';
            if(!expected) {
                alert('Speak the key phrase shown in the scene (the expected phrase is not set).');
                return;
            }
            startPronunciationSession(expected);
        });
    }

    // Wrap original openScene to inject extras (keep existing behavior then enhance)
    if(typeof openScene === 'function'){
        const originalOpen = openScene;
        window.openScene = function(unitId, sceneId){
            originalOpen(unitId, sceneId);
            try {
                const unit = window.units.find(u=>u.id==unitId);
                const scene = unit && unit.scenes.find(s=>s.id==sceneId);
                // illustration
                if(scene && scene.illustration){
                    illustration.src = scene.illustration;
                    illustration.alt = `${scene.title} illustration`;
                } else {
                    illustration.src = '';
                    illustration.alt = 'No illustration';
                }
                // audio
                if(scene && scene.audio){
                    audioPlayer.src = scene.audio;
                    audioPlayer.style.display = 'block';
                } else {
                    audioPlayer.src = '';
                    audioPlayer.style.display = 'none';
                }
                // pronunciation expected phrase saved on button
                const pbtn = document.getElementById('startPronounce');
                if(pbtn){
                    pbtn.dataset.expected = scene && scene.keyPhrase ? scene.keyPhrase : (scene && scene.vocabFocus ? scene.vocabFocus : '');
                    document.getElementById('pronounceScore').textContent = '';
                }
                // animated reset
                illustration.classList.remove('wiggle');

                // set interactive note
                modalInteractive.textContent = scene && scene.interactive ? scene.interactive : 'Tap a scene to see interactive options';

            } catch(e){
                console.error(e);
            }
        };
    }

    // Small accessibility: close dict popup when modal closes
    const closeModalBtn = document.getElementById('closeModal');
    if(closeModalBtn){
        closeModalBtn.addEventListener('click', ()=> { dictPopup.style.display='none'; });
    }
    backdrop.addEventListener('click', (ev)=>{
        if(ev.target === backdrop) dictPopup.style.display='none';
    });

    // Ensure vocabListBtn exists globally
    const vocabListBtn = document.getElementById('vocabListBtn');
    if(vocabListBtn) vocabListBtn.title = 'Open full unit vocabulary';

    // Final: if there are no scene buttons because createUnitCard was not loaded earlier, create a simple units view
    if(!document.querySelector('.unit') && unitsGrid){
        unitsGrid.innerHTML = '';
        window.units.forEach(unit=>{
            const wrap = document.createElement('div');
            wrap.className = 'unit';
            wrap.style.padding = '12px';
            wrap.innerHTML = `<h2 style="margin:0">${unit.title}</h2><p class="meta">Scenes: ${unit.scenes.length}</p>`;
            const openBtn = document.createElement('button');
            openBtn.className = 'scene-btn';
            openBtn.textContent = 'Open first scene';
            openBtn.addEventListener('click', ()=> openScene(unit.id, unit.scenes[0].id));
            wrap.appendChild(openBtn);
            unitsGrid.appendChild(wrap);
        });
    }

})();
</script>